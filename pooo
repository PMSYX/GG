local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer 

-- 1. เริ่มต้นด้วยการรอคอย Service พื้นฐานให้พร้อม
print("Waiting for essential services...")

-- 2. ใช้ WaitForChild และตรวจสอบการโหลด Remote Service
local Knit = ReplicatedStorage:WaitForChild("Packages", 30):FindFirstChild("Knit")
if not Knit then error("Knit Package not found.") end

local Services = Knit:FindFirstChild("Services")
if not Services then error("Services Folder not found.") end

local MonsterService = Services:WaitForChild("MonsterService", 30)
if not MonsterService then error("MonsterService not found. Cannot continue script.") end

local RF_Folder = MonsterService:WaitForChild("RF", 30)
if not RF_Folder then error("RF Folder not found.") end

local CanAttackRF = RF_Folder:WaitForChild("CanAttack", 30)
local RequestAttackRF = RF_Folder:WaitForChild("RequestAttack", 30)

if not CanAttackRF or not RequestAttackRF then
    error("Required Remote Functions (CanAttack or RequestAttack) not found after waiting.")
end

-- 3. การแก้ไข: รอ The Grand Arena ให้โหลดเสร็จสมบูรณ์
local arenaModel = Workspace:WaitForChild("The Grand Arena", 60)
local roomsFolder = arenaModel:WaitForChild("Rooms", 30)
local room1 = roomsFolder:WaitForChild("1", 30) 
print("Map model is now loaded.")

-- ** <--- การแก้ไขปัญหาประตูเหลืองที่สำคัญ ---> **
local YELLOW_BARRIER_PART = nil 

local function findYellowBarrier()
    -- ค้นหา Part ประตูเหลือง (ใช้การค้นหาที่กว้างขึ้น)
    local doorModel = room1:FindFirstChild("Door")
    if doorModel then
        local wallGate = doorModel:FindFirstChild("Wallgate")
        if wallGate then
            -- คาดว่า Part ประตูเหลืองคือ Part ภายใน Wallgate
            return wallGate:FindFirstChild("Part") 
        end
    end
    -- Fallback: ค้นหาใน Room 1 โดยตรง (อาจจะชื่อ "Wall" หรือ "Barrier")
    return room1:FindFirstChild("Wall") or room1:FindFirstChild("Barrier")
end
-- ** <--- สิ้นสุดการแก้ไขปัญหาประตูเหลือง ---> **


-- ฟังก์ชันรอเกมเริ่ม (รอให้ประตูเหลืองหายไป)
local function waitForGameStart()
    print("Waiting for the current round barrier to disappear...")
    
    -- พยายามหา Part ประตูเหลืองตัวจริงใน Room 1
    local currentBarrier = findYellowBarrier()
    
    if currentBarrier then
        print("Found barrier part. Waiting for its removal/change...")
        
        -- ใช้ AncestryChanged:Wait() ที่น่าเชื่อถือที่สุด (รอจนกว่า Part จะถูกย้าย/ทำลาย)
        currentBarrier.AncestryChanged:Wait()
        
        -- เพิ่มการรอคอย 0.5s เพื่อให้เกมประมวลผลการลบ Collision
        wait(0.5) 
    else
        -- ถ้าหาส่วนประตูไม่เจอ (อาจจะหายไปแล้ว) ให้รอเวลา 7 วินาทีตามปกติ
        print("Barrier not found (already gone?). Waiting 7 seconds as countdown fallback...")
        wait(7) 
    end
    
    print("Round Start Confirmed. Continuing Auto-Farm script...")
end 

print("Starting Auto-Farm (Clean Version)...")

-- รอประตูเปิดครั้งแรก
waitForGameStart()

while true do
    wait(1) 

    local playerCharacter = LocalPlayer.Character
    local playerRootPart = playerCharacter and playerCharacter:FindFirstChild("HumanoidRootPart")

    if not playerRootPart then
        print("Waiting for character...")
        continue 
    end
    
    local playerPosition = playerRootPart.Position

    local closestMonster = nil
    local minDistance = math.huge

    for i, room in pairs(roomsFolder:GetChildren()) do
        
        local enemiesFolder = room:FindFirstChild("Enemies")
        
        if enemiesFolder then
            
            for j, monster in pairs(enemiesFolder:GetChildren()) do
                
                local humanoid = monster:FindFirstChildOfClass("Humanoid")
                local monsterRootPart = monster:FindFirstChild("HumanoidRootPart")
                
                if humanoid and humanoid.Health > 0 and monsterRootPart then
                    
                    local monsterPosition = monsterRootPart.Position
                    local distance = (playerPosition - monsterPosition).Magnitude
                    
                    if distance < minDistance then
                        minDistance = distance
                        closestMonster = monster
                    end
                end
            end
        end
    end

    if closestMonster then
        
        local targetRootPart = closestMonster:FindFirstChild("HumanoidRootPart")
        local targetCFrame = targetRootPart.CFrame
        
        -- *** ตรวจสอบซ้ำ: ถ้า Part ประตูยังอยู่ ให้รอก่อน ***
        if findYellowBarrier() then
             print("Monster found, but door is still physically present! Waiting...")
             wait(2)
             continue
        end
        
        playerRootPart.CFrame = targetCFrame * CFrame.new(0, 5, 0)
        wait(0.1)

        local argsCanAttack = { LocalPlayer }
        local canActuallyAttack = CanAttackRF:InvokeServer(unpack(argsCanAttack))
        
        if canActuallyAttack then
            local argsRequestAttack = { targetCFrame }
            RequestAttackRF:InvokeServer(unpack(argsRequestAttack))
            wait(0.8) 
        else
            print("CanAttack = false (Cooldown?)")
        end
    else
        print("No living monsters found. Waiting...")
        
        print("Waiting for next round countdown...")
        wait(5) 
        waitForGameStart() 
        
        wait(2)
    end
end
