-- 1. Setup Services
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage") -- เพิ่มเข้ามา
local LocalPlayer = Players.LocalPlayer

-- 2. Setup Attack RemoteFunctions (จากสคริปต์ก่อนหน้า)
print("Loading Attack Functions...")
local Knit = ReplicatedStorage:WaitForChild("Packages", 30):FindFirstChild("Knit")
local Services = Knit:FindFirstChild("Services")
local MonsterService = Services:WaitForChild("MonsterService", 30)
local RF_Folder = MonsterService:WaitForChild("RF", 30)
local CanAttackRF = RF_Folder:WaitForChild("CanAttack", 30)
local RequestAttackRF = RF_Folder:WaitForChild("RequestAttack", 30)

-- ตรวจสอบว่าหา RemoteFunctions เจอ
if not CanAttackRF or not RequestAttackRF then
    error("Could not find Attack RemoteFunctions via Knit.")
end
print("Attack Functions Ready!")

-- 3. Farm Configuration
local FARM_DELAY = 1.0 -- Delay ระหว่างการค้นหาแต่ละครั้ง
local targetNames = {
    ["Tang Tang Tang Tang Kelentang"] = true,
    ["AIessio"] = true,
    ["TrikitrakateIas"] = true,
    ["Tri Tri Tri Tri Tri Tri Tri Tri Tri Tri Tri Sarur"] = true,
    ["Tombstone"] = true
}

-- 4. Attack Function (จากสคริปต์ก่อนหน้า)
local function AttackMonster(targetMonster)
    
    if not targetMonster then
        print("AttackMonster: No target provided.")
        return
    end
    
    local targetRootPart = targetMonster:FindFirstChild("HumanoidRootPart")
    if not targetRootPart then
        print("AttackMonster: Target has no HumanoidRootPart.")
        return
    end

    -- 1. ตรวจสอบว่าโจมตีได้หรือไม่ (เช็ค Cooldown)
    local canAttack = CanAttackRF:InvokeServer(LocalPlayer)
    
    if canAttack then
        -- 2. ถ้าโจมตีได้, ส่งคำขอโจมตี
        print("Attacking:", targetMonster.Name)
        RequestAttackRF:InvokeServer(targetRootPart.CFrame)
        
        -- รอ Cooldown ของการโจมตี
        wait(0.8) 
    else
        print("Cannot attack (Cooldown?)")
    end
end

-- 5. Main Auto-Farm Loop
print("Starting Auto-Farm Loop...")
while true do
    wait(FARM_DELAY)
    
    local playerCharacter = LocalPlayer.Character
    local playerRootPart = playerCharacter and playerCharacter:FindFirstChild("HumanoidRootPart")
    
    if not playerRootPart then 
        continue 
    end
    
    local playerPosition = playerRootPart.Position
    local closestMonster = nil
    local minDistance = math.huge
    
    -- ค้นหามอนสเตอร์เป้าหมาย
    for _, descendant in pairs(Workspace:GetDescendants()) do
        if descendant:IsA("Humanoid") then
            local humanoid = descendant
            local monster = humanoid.Parent
            local monsterRootPart = monster:FindFirstChild("HumanoidRootPart")
            
            -- ตรวจสอบว่า 1) ไม่ใช่ผู้เล่น, 2) ชื่ออยู่ใน List, 3) เลือดมากกว่า 0, 4) มี RootPart
            local isPlayer = Players:GetPlayerFromCharacter(monster)
            local isTargetName = targetNames[monster.Name]
            
            if isPlayer == nil and isTargetName and humanoid.Health > 0 and monsterRootPart then
                local distance = (playerPosition - monsterRootPart.Position).Magnitude
                if distance < minDistance then
                    minDistance = distance
                    closestMonster = monster
                end
            end
        end
    end
    
    -- ถ้าเจอมอนสเตอร์
    if closestMonster then
        local targetRootPart = closestMonster:FindFirstChild("HumanoidRootPart")
        if targetRootPart then
            
            -- 1. Teleport (จากสคริปต์ของคุณ)
            playerRootPart.CFrame = targetRootPart.CFrame * CFrame.new(0, 5, 0)
            wait(0.1) -- รอให้เทเลพอร์ตเสร็จก่อนโจมตี
            
            -- 2. Attack (เรียกใช้ฟังก์ชันที่รวมเข้ามา)
            AttackMonster(closestMonster)
        end
    end
end
