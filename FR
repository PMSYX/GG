-- 1. Setup Services
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer

-- 2. Setup Attack RemoteFunctions
print("Loading Attack Functions...")
local Knit = ReplicatedStorage:WaitForChild("Packages", 30):FindFirstChild("Knit")
local Services = Knit:FindFirstChild("Services")
local MonsterService = Services:WaitForChild("MonsterService", 30)
local RF_Folder = MonsterService:WaitForChild("RF", 30)
local CanAttackRF = RF_Folder:WaitForChild("CanAttack", 30)
local RequestAttackRF = RF_Folder:WaitForChild("RequestAttack", 30)

if not CanAttackRF or not RequestAttackRF then
    error("Could not find Attack RemoteFunctions via Knit.")
end
print("Attack Functions Ready!")

-- 3. Farm Configuration
local FARM_DELAY = 0.1
local ATTACK_COOLDOWN = 0.6

-- << [ปรับแก้] สร้าง List ลำดับความสำคัญ
-- Priority 1 = Boss (เล็งก่อน)
-- Priority 2 = Mob ธรรมดา (เล็งทีหลัง)
local targetPriorities = {
    -- Priority 1 (Boss)
    ["Ferro Ferro Ferro Ferro Ferro Ferro Ferro Ferro Ferro Ferro Ferro Sahur"] = 1,
    ["Ketupat Kepat Kupat Prekupat"] = 1

    -- Priority 2 (Regular Mobs)
    ["Old Coffin"] = 2,
    ["AIessio"] = 2,
    ["Rune"] = 2,
    ["TrikitrakateIas"] = 2,
    ["Tang Tang Tang Tang Kelentang"] = 2
    ["Tombstone"] = 2
}


-- 4. Attack Function (เหมือนเดิม)
local function AttackMonster(targetMonster)
    if not targetMonster then return end
    local targetRootPart = targetMonster:FindFirstChild("HumanoidRootPart")
    if not targetRootPart then return end

    local canAttack = CanAttackRF:InvokeServer(LocalPlayer)
    
    if canAttack then
        print("Attacking (Priority Target):", targetMonster.Name)
        RequestAttackRF:InvokeServer(targetRootPart.CFrame)
        task.wait(ATTACK_COOLDOWN)
    else
        print("Cannot attack (Cooldown?)")
    end
end

-- 5. Main Auto-Farm Loop
print("Starting Auto-Farm Loop...")
while true do
    task.wait(FARM_DELAY)
    
    local playerCharacter = LocalPlayer.Character
    local playerRootPart = playerCharacter and playerCharacter:FindFirstChild("HumanoidRootPart")
    
    if not playerRootPart then 
        continue 
    end
    
    local playerPosition = playerRootPart.Position
    
    -- << [ปรับแก้] ตัวแปรสำหรับเก็บเป้าหมายที่ดีที่สุด
    local bestTarget = nil
    local bestPriority = math.huge -- ค่าเริ่มต้นคือ "แย่ที่สุด" (เลขเยอะ)
    local minDistance = math.huge
    
    -- << [ปรับแก้] ตรรกะการค้นหาใหม่
    for _, descendant in pairs(Workspace:GetDescendants()) do
        if descendant:IsA("Humanoid") then
            local humanoid = descendant
            local monster = humanoid.Parent
            local monsterRootPart = monster:FindFirstChild("HumanoidRootPart")
            
            local priority = targetPriorities[monster.Name]
            local isPlayer = Players:GetPlayerFromCharacter(monster)
            
            if priority and isPlayer == nil and humanoid.Health > 0 and monsterRootPart then
                
                local distance = (playerPosition - monsterRootPart.Position).Magnitude
                
                -- ตรรกะใหม่:
                -- 1. ถ้าตัวที่เจอ "สำคัญกว่า" (priority เลขน้อยกว่า) ตัวที่ถืออยู่ -> เลือกตัวนี้ทันที
                -- 2. ถ้า "สำคัญเท่ากัน" -> ค่อยเช็คระยะทางว่าใกล้กว่าหรือไม่
                
                if priority < bestPriority then
                    -- เจอตัวที่สำคัญกว่า (เช่น เจอ Boss ในขณะที่ก่อนหน้านี้เจอแค่ Mob)
                    bestPriority = priority
                    minDistance = distance
                    bestTarget = monster
                elseif priority == bestPriority and distance < minDistance then
                    -- สำคัญเท่ากัน (เช่น Boss กับ Boss หรือ Mob กับ Mob) ให้เลือกตัวที่ใกล้กว่า
                    minDistance = distance
                    bestTarget = monster
                end
            end
        end
    end
    
    -- ถ้าเจอมอนสเตอร์ (ไม่ว่าจะ Boss หรือ Mob)
    if bestTarget then -- << [ปรับแก้] ใช้ bestTarget แทน closestMonster
        local targetRootPart = bestTarget:FindFirstChild("HumanoidRootPart")
        if targetRootPart then
            
            -- 1. Teleport
            playerRootPart.CFrame = targetRootPart.CFrame * CFrame.new(0, 5, 0)
            
            -- 2. Attack
            AttackMonster(bestTarget) -- << [ปรับแก้] ส่ง bestTarget ไปโจมตี
        end
    end
end
