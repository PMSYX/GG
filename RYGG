-- ‚öîÔ∏è Auto-Farm Script (Clean Version) ü§ñ

local Knit = require(game:GetService("ReplicatedStorage"):WaitForChild("Packages", 30)):FindFirstChild("Knit")
if not Knit then error("Knit Package not found.") end

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer

if not LocalPlayer then
    Players.PlayerAdded:Wait()
    LocalPlayer = Players.LocalPlayer
end

---
-- üõ†Ô∏è Initialization & Service Setup
---

print("Waiting for essential services...")

local Services = Knit:FindFirstChild("Services")
if not Services then error("Services Folder not found.") end

local MonsterService = Services:WaitForChild("MonsterService", 30)
if not MonsterService then error("MonsterService not found. Cannot continue script.") end

local RF_Folder = MonsterService:WaitForChild("RF", 30)
if not RF_Folder then error("RF Folder (RemoteFunctions) not found.") end

local CanAttackRF = RF_Folder:WaitForChild("CanAttack", 30)
local RequestAttackRF = RF_Folder:WaitForChild("RequestAttack", 30)

if not CanAttackRF or not RequestAttackRF then
    error("Required Remote Functions (CanAttack or RequestAttack) not found.")
end

local arenaModel = Workspace:WaitForChild("The Grand Arena", 60)
local roomsFolder = arenaModel:WaitForChild("Rooms", 30)
local room1 = roomsFolder:WaitForChild("1", 30)
print("‚úÖ Map model and essential services loaded.")

---
-- üö™ Barrier & Game Start Logic
---

local function findYellowBarrier()
    local doorModel = room1:FindFirstChild("Door")
    
    if doorModel then
        for _, obj in ipairs(doorModel:GetChildren()) do
            if obj:IsA("BasePart") and obj.Transparency < 1 then
                return obj
            end
        end
    end
    
    return nil
end

local function waitForGameStart()
    print("‚è≥ Waiting for the current round barrier to disappear...")
    
    local currentBarrier = findYellowBarrier()
    local startTime = tick()
    local timeout = 30 
    
    while currentBarrier and (tick() - startTime < timeout) do
        print("üö™ Barrier is present. Waiting for round start...")
        
        local changedSignal = currentBarrier.AncestryChanged:Connect(function() end)
        
        local success, err = pcall(function()
            currentBarrier.AncestryChanged:Wait()
        end)
        
        changedSignal:Disconnect() 

        if success and not currentBarrier.Parent then
            print("üéâ Barrier confirmed as removed/destroyed.")
            wait(0.5) 
            return
        end
        
        wait(1)
        currentBarrier = findYellowBarrier() 
    end
    
    if currentBarrier then
         print("‚ö†Ô∏è Timeout waiting for barrier removal. Proceeding with 5s cooldown fallback.")
         wait(5)
    else
        print("‚úÖ Round Start Confirmed. Continuing Auto-Farm.")
    end
end

---
-- üéØ Main Auto-Farm Loop
---

print("üöÄ Starting Auto-Farm loop...")

waitForGameStart() 

while true do
    
    local playerCharacter = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local playerRootPart = playerCharacter:FindFirstChild("HumanoidRootPart")

    if not playerRootPart then
        print("Waiting for player character/root part...")
        wait(1)
        continue 
    end
    
    local playerPosition = playerRootPart.Position

    local closestMonster = nil
    local minDistance = math.huge

    for _, room in ipairs(roomsFolder:GetChildren()) do
        local enemiesFolder = room:FindFirstChild("Enemies")
        
        if enemiesFolder then
            for _, monster in ipairs(enemiesFolder:GetChildren()) do
                local humanoid = monster:FindFirstChildOfClass("Humanoid")
                local monsterRootPart = monster:FindFirstChild("HumanoidRootPart")
                
                if humanoid and humanoid.Health > 0 and monsterRootPart then
                    local distance = (playerPosition - monsterRootPart.Position).Magnitude
                    
                    if distance < minDistance then
                        minDistance = distance
                        closestMonster = monster
                    end
                end
            end
        end
    end

    if closestMonster then
        
        if findYellowBarrier() then
            print("üö® Monster found, but door is still present! Re-entering wait loop.")
            waitForGameStart() 
            continue
        end
        
        local targetRootPart = closestMonster:FindFirstChild("HumanoidRootPart")
        if not targetRootPart then wait(1) continue end
        
        local targetCFrame = targetRootPart.CFrame
        
        playerRootPart.CFrame = targetCFrame * CFrame.new(0, 5, 0)
        wait(0.1) 

        local canActuallyAttack = CanAttackRF:InvokeServer(LocalPlayer)
        
        if canActuallyAttack then
            RequestAttackRF:InvokeServer(targetCFrame)
            wait(0.8) 
        else
            print("‚ùå CanAttack returned false (Cooldown or Server check fail).")
            wait(0.5)
        end
    else
        print("üò¥ No living monsters found. Waiting for next round...")
        
        if findYellowBarrier() then
             waitForGameStart()
        end

        wait(5) 
        waitForGameStart() 
        wait(2)
    end
end
