local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer

local Knit = ReplicatedStorage:WaitForChild("Packages", 30):FindFirstChild("Knit")
local Services = Knit:FindFirstChild("Services")
local MonsterService = Services:WaitForChild("MonsterService", 30)
local RF_Folder = MonsterService:WaitForChild("RF", 30)
local CanAttackRF = RF_Folder:WaitForChild("CanAttack", 30)
local RequestAttackRF = RF_Folder:WaitForChild("RequestAttack", 30)

if not CanAttackRF or not RequestAttackRF then
    error("Could not find Attack RemoteFunctions via Knit.")
end

local FARM_DELAY = 0.1
local ATTACK_COOLDOWN = 0.6
local targetPriorities = {
    ["Ferro Ferro Ferro Ferro Ferro Ferro Ferro Ferro Ferro Ferro Ferro Sahur"] = 1,
    ["Ketupat Kepat Kupat Prekupat"] = 1,
    ["Old Coffin"] = 2,
    ["AIessio"] = 2,
    ["Rune"] = 2,
    ["TrikitrakateIas"] = 2,
    ["Tang Tang Tang Tang Kelentang"] = 2,
    ["Tombstone"] = 2
}

local function AttackMonster(targetMonster)
    local targetRootPart = targetMonster and targetMonster:FindFirstChild("HumanoidRootPart")
    if not targetRootPart then return end

    if CanAttackRF:InvokeServer(LocalPlayer) then
        RequestAttackRF:InvokeServer(targetRootPart.CFrame)
        task.wait(ATTACK_COOLDOWN)
    end
end

while task.wait(FARM_DELAY) do
    local playerCharacter = LocalPlayer.Character
    local playerRootPart = playerCharacter and playerCharacter:FindFirstChild("HumanoidRootPart")
    
    if playerRootPart then
        local playerPosition = playerRootPart.Position
        local bestTarget = nil
        local bestPriority = math.huge
        local minDistance = math.huge
        
        for _, descendant in pairs(Workspace:GetDescendants()) do
            if descendant:IsA("Humanoid") then
                local humanoid = descendant
                local monster = humanoid.Parent
                local monsterRootPart = monster:FindFirstChild("HumanoidRootPart")
                
                local priority = targetPriorities[monster.Name]
                local isPlayer = Players:GetPlayerFromCharacter(monster)
                
                if priority and isPlayer == nil and humanoid.Health > 0 and monsterRootPart then
                    local distance = (playerPosition - monsterRootPart.Position).Magnitude
                    
                    if priority < bestPriority then
                        bestPriority = priority
                        minDistance = distance
                        bestTarget = monster
                    elseif priority == bestPriority and distance < minDistance then
                        minDistance = distance
                        bestTarget = monster
                    end
                end
            end
        end
        
        if bestTarget then
            local targetRootPart = bestTarget:FindFirstChild("HumanoidRootPart")
            if targetRootPart then
                playerRootPart.CFrame = targetRootPart.CFrame * CFrame.new(0, 5, 0)
                AttackMonster(bestTarget)
            end
        end
    end
end
