local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer 

local MonsterService = ReplicatedStorage:WaitForChild("Packages"):WaitForChild("Knit"):WaitForChild("Services"):WaitForChild("MonsterService")
local CanAttackRF = MonsterService:WaitForChild("RF"):WaitForChild("CanAttack")
local RequestAttackRF = MonsterService:WaitForChild("RF"):WaitForChild("RequestAttack")

local roomsFolder = Workspace:WaitForChild("The Grand Arena"):WaitForChild("Rooms")
local room1 = roomsFolder:WaitForChild("1") 

local function waitForGameStart()
    print("Waiting for the door in Room 1 to open (Transparency check)...")
    
    local doorModel = room1:FindFirstChild("Door")
    local barrierPart = nil
    
    if doorModel then 
        
        local wallGate = doorModel:FindFirstChild("Wallgate")
        if wallGate then
            barrierPart = wallGate:FindFirstChild("Part")
        end
        
        if barrierPart then
            print("Found barrier part. Monitoring its Transparency...")
            
            if barrierPart.Transparency < 1 then
                print("Door is currently closed. Waiting for property change...")
                
                local connection = barrierPart:GetPropertyChangedSignal("Transparency"):Connect(function()
                    if barrierPart.Transparency >= 1 then
                        print("Door opened (Transparency = 1).")
                        connection:Disconnect() 
                    end
                end)
                
                repeat
                    wait(0.1)
                until barrierPart.Transparency >= 1

                if connection.Connected then
                    connection:Disconnect() 
                end
                
            end 
            
        else
            print("Could not find the specific barrier Part in Room 1. Waiting 6 seconds as fallback...")
            wait(6) 
        end
        
    else
        print("Could not find 'Door' model in Room 1. Waiting 6 seconds as fallback...")
        wait(6)
    end 
    
    print("Game Start Signal Received. Continuing Auto-Farm script...")
end 

print("Starting Auto-Farm (Clean Version)...")

waitForGameStart()

while true do
    wait(0.5) 

    local playerCharacter = LocalPlayer.Character
    local playerRootPart = playerCharacter and playerCharacter:FindFirstChild("HumanoidRootPart")

    if not playerRootPart then
        print("Waiting for character...")
        continue 
    end
    
    local playerPosition = playerRootPart.Position

    local closestMonster = nil
    local minDistance = math.huge

    for i, room in pairs(roomsFolder:GetChildren()) do
        
        local enemiesFolder = room:FindFirstChild("Enemies")
        
        if enemiesFolder then
            
            for j, monster in pairs(enemiesFolder:GetChildren()) do
                
                local humanoid = monster:FindFirstChildOfClass("Humanoid")
                local monsterRootPart = monster:FindFirstChild("HumanoidRootPart")
                
                if humanoid and humanoid.Health > 0 and monsterRootPart then
                    
                    local monsterPosition = monsterRootPart.Position
                    local distance = (playerPosition - monsterPosition).Magnitude
                    
                    if distance < minDistance then
                        minDistance = distance
                        closestMonster = monster
                    end
                end
            end
        end
    end

    if closestMonster then
        
        local targetRootPart = closestMonster:FindFirstChild("HumanoidRootPart")
        local targetCFrame = targetRootPart.CFrame
        
        playerRootPart.CFrame = targetCFrame * CFrame.new(0, 5, 0)
        wait(0.1)

        local argsCanAttack = { LocalPlayer }
        local canActuallyAttack = CanAttackRF:InvokeServer(unpack(argsCanAttack))
        
        if canActuallyAttack then
            local argsRequestAttack = { targetCFrame }
            RequestAttackRF:InvokeServer(unpack(argsRequestAttack))
            wait(0.5)
        else
            print("CanAttack = false (Cooldown?)")
        end
    else
        print("No living monsters found. Waiting...")
        wait(2)
    end
end
